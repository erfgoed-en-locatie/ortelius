---
---
<!DOCTYPE html>
<html>
  <head>
		<meta charset="utf-8">
    <title>Ortelius</title>
    <link rel="stylesheet" href="{{ site.baseurl }}/css/style.css" />
    <link rel="stylesheet" href="{{ site.baseurl }}/css/codemirror.css">
    <link href='{{ site.baseurl }}/css/leaflet.css' rel='stylesheet' />
    <script src='{{ site.baseurl }}/js/leaflet.js'></script>
    <script src="{{ site.baseurl }}/js/d3.v3.min.js"></script>
    <script src='{{ site.baseurl }}/js/leaflet-hash.js'></script>
    <script src='{{ site.baseurl }}/js/codemirror.js'></script>
    <script src="{{ site.baseurl }}/js/codemirror-javascript.js"></script>
  </head>
  <body>
    <div id="map"></div>
    <section id="sidebar">
      <div class="sidebar-item">
        <div class="sidebar-item-container">
          <input id="search" type="text" placeholder="Search" />
        </div>
      </div>
      <div class="sidebar-item">
        <div class="sidebar-item-container">
          <textarea id="editor"></textarea>
        </div>
      </div>
    </section>
    <script>
      var peliasEndpoint = '{{ site.data.pelias.endpoint }}',
          peliasResults = "";

      var map = L.map('map', {
        zoomControl: false,
  			minZoom: 7,
  			maxZoom: 18
  		});

      geojsonLayer = L.geoJson().addTo(map);

      map.setView([{{ site.data.map.center[0] }}, {{ site.data.map.center[1] }}], {{ site.data.map.zoom }});
      var hash = new L.Hash(map);

  		var tileUrl = '{{ site.data.map.tiles }}',
          tileLayer = L.tileLayer(tileUrl, {attribution: '{{ site.data.map.attribution }}'}).addTo(map);

      d3.select("#search").on("keydown", function() {
        if (d3.event.keyCode == 13) {
          var query = d3.select(this).property("value");
          d3.json(peliasEndpoint + "/search?input=" + query, function(error, json) {
            showGeoJSON(json);
          });
        }
      });

      var editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
        lineNumbers: true,
        mode: "javascript"
      });

      function showGeoJSON(json) {
        geojsonLayer.clearLayers();
        peliasResults = json;
        if (json && json.features) {
          geojsonLayer.addData(peliasResults);

          var jsonStr = JSON.stringify(peliasResults, null, 2);
          jsonStr = jsonStr.replace(/"geometry":\s*{(.|\n)*?}/mg, '"geometry": "â€¦"');
          editor.setValue(jsonStr);
          map.fitBounds(geojsonLayer.getBounds());
        }
      }
    </script>
  </body>
</html>
